<!-- PROJECT LOGO -->

<p align="center">
  <a href="https://openliberty.io/">
    <img src="https://openliberty.io/img/spaceship.svg" alt="Logo">
  </a>
</p>
<p align="center">
  <a href="https://openliberty.io/">
    <img src="https://github.com/OpenLiberty/open-liberty/blob/master/logos/logo_horizontal_light_navy.png" alt="title" width="400">
  </a>
</p>
<br />


[![License](https://img.shields.io/badge/License-ASL%202.0-green.svg)](https://opensource.org/licenses/Apache-2.0)

# Summary

A devfile-based application stack for Open Liberty

## Contributing

Our [CONTRIBUTING](https://github.com/OpenLiberty/application-stack/blob/master/CONTRIBUTING.md) document contains details for submitting pull requests.

# Open Liberty Application Stack

The Open Liberty application stack provides a consistent way of developing microservices based upon the [Jakarta EE](https://jakarta.ee/) and [Eclipse MicroProfile](https://microprofile.io) specifications. This stack lets you use [Maven](https://maven.apache.org) to develop applications for [Open Liberty](https://openliberty.io) runtime, that is running on OpenJDK with container-optimizations in OpenJ9.

This stack is based on OpenJDK with container-optimizations in OpenJ9 and `Open Liberty v20.0.0.3`. It provides live reloading during development by utilizing the ["dev mode"](https://openliberty.io/blog/2019/10/22/liberty-dev-mode.html) capability in the liberty-maven-plugin.  

**Note:** Maven is provided by the stack, allowing you to build, test, and debug your Java application without installing Maven locally. However, we recommend installing Maven locally for the best development experience.

## Default starter app

The default starter provides a `pom.xml` file that enables Liberty features that support [Eclipse MicroProfile 3.3](https://openliberty.io/docs/ref/feature/#microProfile-3.3.html). Specifically, this template includes:

#### Health

The `mpHealth` feature allows services to report their readiness and liveness status - UP if it is ready or alive and DOWN if it is not ready/alive. It publishes two corresponding endpoints to communicate the status of liveness and readiness. A service orchestrator can then use the health statuses to make decisions.

Liveness endpoint: http://localhost:9080/health/live
Readiness endpoint: http://localhost:9080/health/ready

#### Metrics

The `mpMetrics` feature enables MicroProfile Metrics support in Open Liberty. Note that this feature requires SSL and the configuration has been provided for you. You can monitor metrics to determine the performance and health of a service. You can also use them to pinpoint issues, collect data for capacity planning, or to decide when to scale a service to run with more or fewer resources.

Metrics endpoint: http://localhost:9080/metrics

##### Metrics Password

Log in as the `admin` user to see both the system and application metrics in a text format.   The password for this `admin` user will be generated by the container.  

To get the generated password for project **my-project**, you can exec in the container like this, for example:

    $ docker exec -it my-project-dev  shell -c "grep keystore /opt/ol/wlp/usr/servers/defaultServer/server.env"

    keystore_password=2r1aquTO3VVUVON7kCDdzno

So in the above example the password value would be: `2r1aquTO3VVUVON7kCDdzno`


#### Junit 5

The default template uses JUnit 5. You may be used to JUnit 4, but here are some great reasons to make the switch https://developer.ibm.com/dwblog/2017/top-five-reasons-to-use-junit-5-java/


## Getting Started

1. Perform an `oc login` to your Open Shift cluster for development purposes.

1.  Get the [odo v.1.2.6](https://mirror.openshift.com/pub/openshift-v4/clients/odo/v1.2.6/) CLI (or later).

1. Odo must be run in experimental mode at the 1.x level in order to access the devfile support. Enable experimental mode using the odo CLI:
    ```shell
    odo preference set experimental true
    ```

1. Create a new folder in your local directory and create an odo project using the Odo CLI, e.g.:
    ```shell
    mkdir my-project
    cd my-project
    odo project create <project namespace name> 
    ```
    The project namespace name will be used to create an openshift namespace that will house your application and related pods

1. Initialize the local folder for the odo project
    ```shell
    odo create java-openliberty <app project name> --starter
    ```
    
    This will initialize an Open Liberty project and download the default starter app artifacts.

1. Create an odo URL that will be used to access the starter app:
    ```shell
    odo url create --port 9080
    ```
1. Once your project has been initialized and the URL created, you can push your application to your openshift cluster for the first time using the following command:

    ```shell
    odo push 
    ```

    Upon a first time `odo push` invocation, the following occurs:
    1. An Open Shift managed kubernetes pod is launched within the namespace created in step 3 above, 
    1. A container based on the image referenced in the devfile is started in that pod 
    1. odo syncs your local source code directory to that container. (under the `/projects` directory)
    1. The app is compiled and built within the container and liberty dev mode is started to host the app once built.
    1. The URL is activated and is usable to access the app 

1. Retrieve the URL created in step 5 using the odo CLI:
    ```shell
    odo url list
    ```
    
    Edits to source code can be made using any preferred IDE (Eclipse, VSCode or others). To see source code changes reflected in the running application re-issue the `odo push` command after any edit session is complete and saved. Source code changes will be reflected in the running container within a few seconds.

1. You should be able to access the following endpoints, as they are exposed by your template application by default:

    - Readiness endpoint: http://`<odo url>`/health/ready
    - Liveness endpoint: http://`<odo url>>`/health/live
    - Metrics endpoint: http://`<odo url>`/metrics (login as `admin` user with password obtained as mentioned [here](#Metrics-Password).
    - OpenAPI endpoint: http://`<odo url>`/openapi
    - Swagger UI endpoint: http://`<odo url>`/openapi/ui

## Odo local development operations: (run/debug/test )

### RUN
By default, `odo push`, in conjuction with the java-openliberty devfile, runs a liberty:dev mode in "hot test" mode, where unit tests and integration tests get automatically re-executed after each detected change. Visibility to the logs on the Open Shift container is to see these test results. To see the realtime contents of the container logs, use the odo CLI:
```shell
odo log
```

It is also possible to disable the "hot test" mode of liberty:dev mode by re-running the `odo push` with the following argument:
```shell
odo push --run-command=run-test-off
```

### DEBUG
Not currently supported

### TEST
Not currently supported

## License

Usage is provided under the [Apache 2.0 license](https://opensource.org/licenses/Apache-2.0).  See LICENSE for the full details.

